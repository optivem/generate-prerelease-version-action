name: test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate action.yml structure
        run: |
          echo "üîç Validating action.yml structure..."
          
          # Check required inputs exist
          if grep -q "image-urls:" action.yml; then
            echo "‚úÖ image-urls input found"
          else
            echo "‚ùå image-urls input missing"
            exit 1
          fi
          
          if grep -q "registry-token:" action.yml; then
            echo "‚úÖ registry-token input found"
          else
            echo "‚ùå registry-token input missing"
            exit 1
          fi
          
          if grep -q "prerelease-suffix:" action.yml; then
            echo "‚úÖ prerelease-suffix input found"
          else
            echo "‚ùå prerelease-suffix input missing"
            exit 1
          fi
          
          echo "‚úÖ Action YAML structure validation passed"

      - name: Test PowerShell script syntax
        run: |
          echo "üîç Testing PowerShell script syntax..."
          
          # Test syntax by running with help
          pwsh -Command "Get-Help ./action.ps1" >/dev/null 2>&1 || echo "‚ö†Ô∏è  PowerShell help check (expected for scripts without help comments)"
          
          # Test parameter validation
          if grep -q "ImageUrls" action.ps1; then
            echo "‚úÖ ImageUrls parameter found"
          else
            echo "‚ùå ImageUrls parameter missing"
            exit 1
          fi
          
          if grep -q "RegistryToken" action.ps1; then
            echo "‚úÖ RegistryToken parameter found"
          else
            echo "‚ùå RegistryToken parameter missing"
            exit 1
          fi
          
          echo "‚úÖ PowerShell script validation passed"

      - name: Test URL parsing logic
        run: |
          echo "üîç Testing URL parsing patterns..."
          
          # Test regex patterns exist
          if grep -q "match.*sha256" action.ps1; then
            echo "‚úÖ Digest pattern found"
          else
            echo "‚ùå Digest pattern missing"
            exit 1
          fi
          
          if grep -q "match.*:" action.ps1; then
            echo "‚úÖ Tag pattern found"
          else
            echo "‚ùå Tag pattern missing"
            exit 1
          fi
          
          echo "‚úÖ URL parsing validation passed"

      - name: Validate documentation consistency
        run: |
          echo "üîç Checking documentation consistency..."
          
          # Check README has new parameters
          if grep -q "image-urls" README.md; then
            echo "‚úÖ README contains image-urls"
          else
            echo "‚ùå README missing image-urls documentation"
            exit 1
          fi
          
          if grep -q "registry-token" README.md; then
            echo "‚úÖ README contains registry-token"
          else
            echo "‚ùå README missing registry-token documentation"
            exit 1
          fi
          
          # Check for old parameters that should be removed
          if grep -q "image-name" README.md; then
            echo "‚ö†Ô∏è  README still contains old image-name parameter"
          else
            echo "‚úÖ Old image-name parameter removed from README"
          fi
          
          if grep -q "github-token" README.md; then
            echo "‚ö†Ô∏è  README still contains old github-token parameter"
          else
            echo "‚úÖ Old github-token parameter removed from README"
          fi
          
          echo "‚úÖ Documentation consistency check completed"

  # Note: Full functional testing would require a Docker image to exist
  # This validates the action structure and parameter consistency